<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Greetings & Introductions ‚Äî Games (updated)</title>
<style>
:root{
  --primary:#2563eb; --accent:#16a34a; --danger:#dc2626;
  --card:#fff; --muted:#64748b;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(135deg,#f0f9ff,#fff7ed);color:#0f172a}
header{background:var(--primary);color:#fff;padding:14px 18px;box-shadow:0 4px 14px rgba(2,6,23,0.12)}
.header-row{display:flex;align-items:center;gap:12px;max-width:1100px;margin:0 auto}
h1{margin:0;font-size:18px}
.container{max-width:1100px;margin:18px auto;padding:0 16px}
.topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0}
.tab{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.secondary{background:#6b7280}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
select{padding:8px 10px;border-radius:8px;border:1px solid #cbd5e1}
main{margin-top:12px}
.game{display:none;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 28px rgba(2,6,23,0.06)}
.visible{display:block}

/* Flashcards */
.flash-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
.flashbox{perspective:1100px;width:360px;height:220px}
.card{width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s;cursor:pointer;position:relative;border-radius:12px}
.card.flip{transform:rotateY(180deg)}
.face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;border-radius:12px;padding:16px;text-align:center}
.front{background:linear-gradient(135deg,#fff,#eef2ff);box-shadow:0 8px 28px rgba(2,6,23,0.08)}
.back{background:linear-gradient(135deg,#dbeafe,#e0f2fe);transform:rotateY(180deg)}

/* Dialog builder */
.dialog-area{display:flex;gap:14px;flex-direction:column;align-items:center}
.draggables{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:900px;padding:8px;border-radius:8px}
.dropzone{min-height:70px;min-width:60%;border:2px dashed #cbd5e1;border-radius:10px;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-start;background:#fbfbff}

/* Match */
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:900px;margin:0 auto}
.tile{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 16px rgba(2,6,23,0.06);cursor:pointer;text-align:center;font-weight:700}

/* Listening / Quiz */
.options{display:flex;flex-direction:column;gap:8px;align-items:center}

/* Typing */
input[type=text]{padding:10px 12px;border-radius:8px;border:1px solid #cbd5e1;width:60%;max-width:420px}

/* small buttons */
.small{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:#64748b;color:white}

/* Firework */
.fire{position:fixed;left:50%;top:20%;transform:translateX(-50%);pointer-events:none;z-index:9999}
.burst{width:8px;height:8px;background:transparent;box-shadow:
  0 -40px 0 0 #ff7ab6,28px -28px 0 0 #ffb86e,40px 0 0 0 #ffd166,28px 28px 0 0 #7ee7c7,0 40px 0 0 #8bd3ff,-28px 28px 0 0 #d3b7ff,-40px 0 0 0 #ff9a9e,-28px -28px 0 0 #f6f59d;
animation:burst .8s ease-out forwards}
@keyframes burst{from{opacity:0;transform:scale(.2)}50%{opacity:1}to{opacity:0;transform:scale(1.6)}}

.footer{margin:18px 0;text-align:center;color:var(--muted);font-size:13px}
@media (max-width:720px){
  .card{font-size:18px}
  .flashbox{width:300px;height:180px}
  .grid{grid-template-columns:repeat(2,1fr)}
  input[type=text]{width:86%}
}
</style>
</head>
<body>
<header>
  <div class="header-row">
    <h1>Greetings & Introductions ‚Äî –Ü–≥—Ä–∏ (–æ–Ω–æ–≤–ª–µ–Ω–æ)</h1>
  </div>
</header>

<div class="container">
  <div class="topbar">
    <button class="tab" onclick="openGame('flash')">üÉè –§–ª–µ—à-–∫–∞—Ä—Ç–∫–∏</button>
    <button class="tab" onclick="openGame('dialog')">üí¨ Dialog Builder</button>
    <button class="tab" onclick="openGame('match')">üß© Match Pairs</button>
    <button class="tab" onclick="openGame('listen')">üéß Listening</button>
    <button class="tab" onclick="openGame('type')">‚úçÔ∏è Typing</button>
    <button class="tab" onclick="openGame('speed')">‚è±Ô∏è Speed Quiz</button>

    <div class="controls">
      <label>–ü—ñ–¥–º–Ω–æ–∂–∏–Ω–∞:</label>
      <select id="count" onchange="applyAll()">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20" selected>20</option>
      </select>
      <button class="tab secondary" onclick="shuffleAll()">üîÄ –ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏ –≤—Å—ñ</button>
    </div>
  </div>

  <main>
    <!-- FLASHCARDS -->
    <section id="flash" class="game visible">
      <div class="flash-wrap">
        <div class="flashbox">
          <div class="card" id="fcard" title="–ö–ª—ñ–∫ ‚Äî –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏">
            <div class="face front" id="f-front"></div>
            <div class="face back" id="f-back"></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="small" onclick="prevFlash()">‚¨ÖÔ∏è</button>
          <button class="small" onclick="shuffleFlash()">üîÄ Shuffle</button>
          <button class="small" onclick="nextFlash()">‚û°Ô∏è</button>
          <button class="small" onclick="speakCurrent()">üîä Speak</button>
        </div>
        <div id="f-status" style="font-weight:700;margin-top:8px"></div>
      </div>
    </section>

    <!-- DIALOG BUILDER -->
    <section id="dialog" class="game">
      <div class="dialog-area">
        <div style="font-weight:700">–°–∫–ª–∞–¥–∏ –¥—ñ–∞–ª–æ–≥ —É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É. –ü–µ—Ä–µ—Ç—è–≥—É–π —Ñ—Ä–∞–∑–∏ —É –ø—Ä–∞–≤–µ –ø–æ–ª–µ. –ú–æ–∂–Ω–∞ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –Ω–∞–∑–∞–¥.</div>
        <div style="display:flex;gap:12px;flex-direction:column;align-items:center;width:100%">
          <div style="width:100%;display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
            <div style="flex:1;min-width:220px">
              <div style="font-weight:600;margin-bottom:8px">–ü—É–ª —Ñ—Ä–∞–∑ (–Ω–∞—Ç–∏—Å–Ω–∏ —ñ –ø–µ—Ä–µ—Ç—è–≥–Ω–∏)</div>
              <div id="dialog-pool" class="draggables" ondragover="event.preventDefault()" ondrop="onDropToPool(event)"></div>
            </div>
            <div style="flex:1;min-width:220px">
              <div style="font-weight:600;margin-bottom:8px">–ó—Ä–æ–±–∏ –¥—ñ–∞–ª–æ–≥ —Ç—É—Ç (drop)</div>
              <div id="dialog-drop" class="dropzone" ondragover="event.preventDefault()" ondrop="onDropToZone(event)"></div>
            </div>
          </div>

          <div style="display:flex;gap:8px">
            <button class="small" onclick="checkDialog()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
            <button class="small" onclick="resetDialog()">–ù–æ–≤–µ</button>
            <button class="small" onclick="showCorrectDialog()">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π</button>
          </div>
          <div id="dialog-status" style="font-weight:700;margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- MATCH PAIRS -->
    <section id="match" class="game">
      <div style="font-weight:700;margin-bottom:8px">–ó–Ω–∞–π–¥–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ (–∞–Ω–≥–ª—ñ–π—Å—å–∫–µ ‚Üî —É–∫—Ä–∞—ó–Ω—Å—å–∫–µ)</div>
      <div class="grid" id="match-grid"></div>
      <div id="match-status" class="status" style="margin-top:8px"></div>
    </section>

    <!-- LISTENING -->
    <section id="listen" class="game">
      <div style="font-weight:700">–°–ª—É—Ö–∞–π –∞–Ω–≥–ª—ñ–π—Å—å–∫—É —ñ –≤–∏–±–∏—Ä–∞–π –ø–µ—Ä–µ–∫–ª–∞–¥</div>
      <div style="margin-top:12px">
        <button class="small" onclick="playListening()">üîä Play</button>
        <button class="small" onclick="shuffleListening()">üîÄ Next set</button>
      </div>
      <div id="listen-uk" style="font-weight:800;margin-top:10px"></div>
      <div class="options" id="listen-options"></div>
      <div id="listen-score" class="status" style="margin-top:8px"></div>
    </section>

    <!-- TYPING -->
    <section id="type" class="game">
      <div style="font-weight:700">–ë–∞—á–∏—à —É–∫—Ä–∞—ó–Ω—Å—å–∫–µ ‚Äî –Ω–∞–ø–∏—à–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é</div>
      <div style="margin-top:10px;font-size:18px" id="type-uk"></div>
      <input id="type-input" type="text" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Enter">
      <div style="margin-top:8px" id="type-feedback" class="status"></div>
      <div style="margin-top:8px">–†–∞—Ö—É–Ω–æ–∫: <span id="type-score" class="score">0</span></div>
    </section>

    <!-- SPEED -->
    <section id="speed" class="game">
      <div style="display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap">
        <div style="font-weight:700">Speed Quiz ‚Äî 30 —Å–µ–∫—É–Ω–¥</div>
        <button class="small" onclick="startSpeed()">Start</button>
        <div id="speed-timer" style="font-weight:800">30s</div>
      </div>
      <div style="margin-top:12px;font-size:18px" id="speed-uk"></div>
      <input id="speed-input" type="text" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é">
      <div id="speed-status" class="status" style="margin-top:8px"></div>
      <div style="margin-top:8px">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: <span id="speed-score" class="score">0</span></div>
    </section>

  </main>

  <div class="footer">–ó–±–µ—Ä–µ–∂–∏ —Ñ–∞–π–ª —è–∫ <code>greetings.html</code> —ñ –≤—ñ–¥–∫—Ä–∏–π —É –±—Ä–∞—É–∑–µ—Ä—ñ ‚Äî –≤—Å–µ –ø—Ä–∞—Ü—é—î –æ—Ñ–ª–∞–π–Ω</div>
</div>

<div id="fire" class="fire" style="display:none"><div class="burst"></div></div>

<script>
/* ===== phrases ===== */
const full = [
 {en:"Hello!", uk:"–ü—Ä–∏–≤—ñ—Ç!"},
 {en:"Hi, how are you?", uk:"–ü—Ä–∏–≤—ñ—Ç, —è–∫ —Ç–∏?"},
 {en:"Nice to meet you.", uk:"–ü—Ä–∏—î–º–Ω–æ –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è."},
 {en:"What‚Äôs your name?", uk:"–Ø–∫ —Ç–µ–±–µ –∑–≤–∞—Ç–∏?"},
 {en:"My name is ‚Ä¶", uk:"–ú–µ–Ω–µ –∑–≤–∞—Ç–∏ ‚Ä¶"},
 {en:"Where are you from?", uk:"–ó–≤—ñ–¥–∫–∏ —Ç–∏?"},
 {en:"I‚Äôm from Ukraine.", uk:"–Ø –∑ –£–∫—Ä–∞—ó–Ω–∏."},
 {en:"How old are you?", uk:"–°–∫—ñ–ª—å–∫–∏ —Ç–æ–±—ñ —Ä–æ–∫—ñ–≤?"},
 {en:"I am ‚Ä¶ years old.", uk:"–ú–µ–Ω—ñ ‚Ä¶ —Ä–æ–∫—ñ–≤."},
 {en:"This is my friend.", uk:"–¶–µ –º—ñ–π –¥—Ä—É–≥."},
 {en:"How do you do?", uk:"–Ø–∫ —Å—è –º–∞—î—à?"},
 {en:"Long time no see!", uk:"–î–∞–≤–Ω–æ –Ω–µ –±–∞—á–∏–ª–∏—Å—è!"},
 {en:"How‚Äôs it going?", uk:"–Ø–∫ —Å–ø—Ä–∞–≤–∏?"},
 {en:"What‚Äôs up?", uk:"–©–æ –Ω–æ–≤–æ–≥–æ?"},
 {en:"Take care!", uk:"–ë–µ—Ä–µ–∂–∏ —Å–µ–±–µ!"},
 {en:"See you later.", uk:"–ü–æ–±–∞—á–∏–º–æ—Å—å –ø—ñ–∑–Ω—ñ—à–µ."},
 {en:"Have a nice day!", uk:"–ì–∞—Ä–Ω–æ–≥–æ –¥–Ω—è!"},
 {en:"Welcome!", uk:"–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!"},
 {en:"Make yourself at home.", uk:"–ü–æ—á—É–≤–∞–π—Å—è —è–∫ —É–¥–æ–º–∞."},
 {en:"It‚Äôs good to see you.", uk:"–†–∞–¥–∏–π —Ç–µ–±–µ –±–∞—á–∏—Ç–∏."}
];

/* ===== helpers ===== */
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}
function pick(n){ return shuffle(full).slice(0,n); }
function rand(a){ return a[Math.floor(Math.random()*a.length)]; }
function firework(){ const el=document.getElementById('fire'); el.style.display='block'; setTimeout(()=>el.style.display='none',900); }

/* ===== active subset ===== */
let active = pick(20);
function buildActive(){ const n = parseInt(document.getElementById('count').value,10)||20; active = pick(n); }

/* ===== UI switching ===== */
function openGame(id){ document.querySelectorAll('.game').forEach(g=>g.classList.remove('visible')); document.getElementById(id).classList.add('visible'); }

/* ===== FLASHCARDS ===== */
let fOrder=[], fIndex=0;
const fcard = document.getElementById('fcard'), ffront=document.getElementById('f-front'), fback=document.getElementById('f-back'), fstatus=document.getElementById('f-status');
fcard.addEventListener('click', ()=> fcard.classList.toggle('flip'));
function startFlash(){
  fOrder = shuffle(active.slice()); fIndex=0; renderFlash();
}
function renderFlash(){
  if(!fOrder.length){ ffront.textContent='‚Äî'; fback.textContent=''; fstatus.textContent=''; return; }
  const w=fOrder[fIndex]; ffront.textContent=w.en; fback.textContent=w.uk; fstatus.textContent=`–ö–∞—Ä—Ç–∫–∞ ${fIndex+1} / ${fOrder.length}`; fcard.classList.remove('flip');
}
function nextFlash(){ if(!fOrder.length) return; fIndex=(fIndex+1)%fOrder.length; renderFlash(); }
function prevFlash(){ if(!fOrder.length) return; fIndex=(fIndex-1+fOrder.length)%fOrder.length; renderFlash(); }
function shuffleFlash(){ fOrder = shuffle(fOrder); fIndex=0; renderFlash(); }
function speak(text){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }
function speakCurrent(){ if(!fOrder.length) return; speak(fOrder[fIndex].en); }

/* ===== DIALOG BUILDER (one correct order, draggable both ways, reorderable) ===== */
let dialogCorrect = []; // correct sequence (array of objects)
let poolItems = []; // DOM items in pool have id 'pool-i'
function startDialog(){
  // We'll build a meaningful dialog sequence of length up to 5 if possible:
  // prefer: greeting, ask name, answer, where from, answer
  const subset = shuffle(active.slice());
  // heuristics for certain roles
  const greet = subset.find(x=>/hello|hi|long time|how‚Äôs it|what‚Äôs up/i.test(x.en.toLowerCase()));
  const askName = subset.find(x=>/what‚Äôs your name|name/i.test(x.en.toLowerCase()));
  const myName = subset.find(x=>/my name is|i am ‚Ä¶|i am/i.test(x.en.toLowerCase()));
  const where = subset.find(x=>/where are you from|where/i.test(x.en.toLowerCase()));
  const from = subset.find(x=>/i‚Äôm from/i.test(x.en.toLowerCase()));
  dialogCorrect = [];
  [greet, askName, myName, where, from].forEach(s=>{ if(s && !dialogCorrect.includes(s)) dialogCorrect.push(s); });
  // fill up to 5
  for(let i=0;i<subset.length && dialogCorrect.length<5;i++){
    const s = subset[i];
    if(!dialogCorrect.includes(s)) dialogCorrect.push(s);
  }
  if(dialogCorrect.length < 2) dialogCorrect = subset.slice(0, Math.min(4, subset.length));
  // make pool (shuffled)
  const pool = shuffle(dialogCorrect.slice()).map((w,i)=>({id:i, en:w.en, uk:w.uk}));
  poolItems = pool;
  // render pool and empty dropzone
  const poolEl = document.getElementById('dialog-pool'), drop=document.getElementById('dialog-drop');
  poolEl.innerHTML=''; drop.innerHTML='';
  pool.forEach(item=>{
    const b = document.createElement('button');
    b.textContent = `${item.en} (${item.uk})`;
    b.className = 'small';
    b.id = 'pool-'+item.id;
    b.draggable = true;
    b.style.margin = '6px';
    b.dataset.idx = item.id;
    b.ondragstart = (ev)=> {
      ev.dataTransfer.setData('text/plain', b.id);
      // mark source
      ev.dataTransfer.setData('source','pool');
    };
    poolEl.appendChild(b);
  });
  // allow drop events handled below (onDropToZone / onDropToPool)
  document.getElementById('dialog-status').textContent='';
}

// helper: find correct id sequence (dialogCorrect mapped to pool ids)
function getCorrectIdSeq(){ 
  // dialogCorrect contains objects; poolItems contain mapping id->object
  // we need to map dialogCorrect order to pool ids by comparing en+uk
  const seq = [];
  dialogCorrect.forEach(dc=>{
    const found = poolItems.find(p=>p.en===dc.en && p.uk===dc.uk);
    if(found) seq.push('pool-'+found.id);
  });
  return seq;
}

// drop handlers
function onDropToZone(ev){
  ev.preventDefault();
  const id = ev.dataTransfer.getData('text/plain');
  if(!id) return;
  const el = document.getElementById(id);
  if(!el) return;
  const zone = document.getElementById('dialog-drop');
  // If element already in zone -> reorder
  if(zone.contains(el)){
    // find position to insert by pointer y (or x)
    insertAtPointer(zone, ev.clientX, ev.clientY, el);
  } else {
    // move from pool to zone: append or insert at pointer
    insertAtPointer(zone, ev.clientX, ev.clientY, el);
    el.draggable = true;
    // change dragstart to mark source as drop now
    el.ondragstart = (e)=> {
      e.dataTransfer.setData('text/plain', el.id);
      e.dataTransfer.setData('source','drop');
    };
  }
}

function onDropToPool(ev){
  ev.preventDefault();
  const id = ev.dataTransfer.getData('text/plain');
  if(!id) return;
  const el = document.getElementById(id);
  if(!el) return;
  const pool = document.getElementById('dialog-pool');
  // If already in pool, reorder (append)
  pool.appendChild(el);
  // restore dragstart to mark source pool
  el.ondragstart = (e)=> {
    e.dataTransfer.setData('text/plain', el.id);
    e.dataTransfer.setData('source','pool');
  };
}

// Insert element into container at the child position nearest pointer
function insertAtPointer(container, clientX, clientY, element){
  const children = Array.from(container.children).filter(c=>c !== element);
  if(children.length===0){ container.appendChild(element); return; }
  let inserted = false;
  for(const child of children){
    const rect = child.getBoundingClientRect();
    // decide based on X coordinate primarily, fallback to Y
    if(clientX < rect.left + rect.width/2){
      container.insertBefore(element, child);
      inserted = true;
      break;
    }
  }
  if(!inserted) container.appendChild(element);
}

// check dialog correctness
function checkDialog(){
  const zone = document.getElementById('dialog-drop');
  const children = Array.from(zone.children);
  const userSeq = children.map(c=>c.id);
  const correctSeq = getCorrectIdSeq();
  // if lengths differ, not correct
  if(userSeq.length !== correctSeq.length){
    document.getElementById('dialog-status').textContent = '–†–æ–∑–º—ñ—Å—Ç—ñ—Ç—å –≤—Å—ñ —Ñ—Ä–∞–∑–∏ —É –¥—ñ–∞–ª–æ–≥';
    return;
  }
  // Compare
  let ok = true;
  for(let i=0;i<correctSeq.length;i++){
    if(userSeq[i] !== correctSeq[i]) { ok = false; break; }
  }
  if(ok){
    document.getElementById('dialog-status').textContent = 'üéâ –ß—É–¥–æ–≤–æ! –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫!';
    firework();
  } else {
    document.getElementById('dialog-status').textContent = '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî —Å–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç–∏';
  }
}

function resetDialog(){ startDialog(); }
function showCorrectDialog(){
  const zone = document.getElementById('dialog-drop');
  zone.innerHTML='';
  const seq = getCorrectIdSeq();
  seq.forEach(id=>{
    const orig = document.getElementById(id);
    // clone original if pool lacks it
    let el = orig;
    if(!el){
      // find pool item by id pattern (should exist)
      el = document.createElement('button');
      const pid = id.replace('pool-','');
      const p = poolItems.find(x=>String(x.id)===pid);
      el.textContent = `${p.en} (${p.uk})`;
      el.className='small';
      el.id = id;
    }
    // attach dragstart for drop->pool moves
    el.draggable = true;
    el.ondragstart = (e)=> {
      e.dataTransfer.setData('text/plain', el.id);
      e.dataTransfer.setData('source','drop');
    };
    zone.appendChild(el);
  });
  document.getElementById('dialog-status').textContent = '–ü–æ–∫–∞–∑–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫';
}

/* ===== MATCH PAIRS ===== */
function startMatch(){
  const pool = shuffle(active.slice());
  const n = Math.min(pool.length, 8);
  const chosen = pool.slice(0,n);
  const tiles = [];
  chosen.forEach(w=>{ tiles.push({text:w.en, id:w.en, pair:w.uk}); tiles.push({text:w.uk, id:w.en, pair:w.en}); });
  const shuffled = shuffle(tiles);
  const grid = document.getElementById('match-grid'); grid.innerHTML=''; let first=null; let found=0;
  shuffled.forEach((t,idx)=>{
    const d = document.createElement('div');
    d.className='tile';
    d.textContent=t.text;
    d.dataset.id = t.id;
    d.dataset.pair = t.pair;
    d.onclick = ()=>{
      if(d.classList.contains('matched')) return;
      d.style.transform='scale(.98)';
      setTimeout(()=>d.style.transform='scale(1)',120);
      if(!first){ first = d; d.style.background='#fde68a'; return; }
      if(first.dataset.id === d.dataset.id && first !== d){
        first.classList.add('matched'); d.classList.add('matched');
        first.style.background='#bbf7d0'; d.style.background='#bbf7d0';
        found++;
        if(found === n) { document.getElementById('match-status').textContent='üéâ –£—Å—ñ –ø–∞—Ä–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ!'; firework(); }
      } else {
        first.style.background=''; d.style.background='#fecaca';
        setTimeout(()=>{ if(first) first.style.background=''; if(d) d.style.background=''; },600);
      }
      first = null;
    };
    grid.appendChild(d);
  });
  document.getElementById('match-status').textContent='';
}

/* ===== LISTENING ===== */
let listenOrder=[], listenIndex=0, listenScore=0;
function startListening(){
  listenOrder = shuffle(active.slice());
  listenIndex = 0; listenScore = 0;
  renderListening();
}
function renderListening(){
  const ukEl = document.getElementById('listen-uk'), opts = document.getElementById('listen-options');
  if(listenIndex >= listenOrder.length){ ukEl.textContent='–ì–æ—Ç–æ–≤–æ!'; opts.innerHTML=''; document.getElementById('listen-score').textContent = `–†–∞—Ö—É–Ω–æ–∫: ${listenScore}/${listenOrder.length}`; firework(); return; }
  const item = listenOrder[listenIndex];
  ukEl.textContent = '–°–ª—É—Ö–∞—î–º–æ...';
  const options = [item.uk];
  while(options.length < 4){ const c = rand(active).uk; if(!options.includes(c)) options.push(c); }
  const shuffledOpts = shuffle(options);
  opts.innerHTML = '';
  shuffledOpts.forEach(o=>{
    const b = document.createElement('button'); b.className='small'; b.textContent=o; b.style.margin='6px';
    b.onclick = ()=>{
      if(o === item.uk){ listenScore++; b.style.background='#bbf7d0'; }
      else { b.style.background='#fecaca'; }
      listenIndex++; setTimeout(()=>renderListening(),400);
    };
    opts.appendChild(b);
  });
  speak(item.en);
  document.getElementById('listen-score').textContent = `–†–∞—Ö—É–Ω–æ–∫: ${listenScore}/${listenOrder.length}`;
}
function playListening(){ renderListening(); }
function shuffleListening(){ startListening(); }

/* ===== TYPING ===== */
let typeCurrent=null, typeScore=0;
function startTyping(){ typeScore=0; document.getElementById('type-score').textContent=typeScore; nextType(); }
function nextType(){ typeCurrent = rand(active); document.getElementById('type-uk').textContent = typeCurrent.uk; document.getElementById('type-input').value=''; document.getElementById('type-input').focus(); document.getElementById('type-feedback').textContent=''; }
document.getElementById('type-input').addEventListener('keyup', (e)=>{
  if(e.key !== 'Enter') return;
  const val = e.target.value.trim().toLowerCase();
  if(!typeCurrent) return;
  if(val === typeCurrent.en.toLowerCase()){ typeScore++; document.getElementById('type-feedback').textContent='‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ'; document.getElementById('type-feedback').style.color='green'; }
  else { document.getElementById('type-feedback').textContent=`‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω–∞: ${typeCurrent.en}`; document.getElementById('type-feedback').style.color='red'; }
  document.getElementById('type-score').textContent = typeScore;
  setTimeout(nextType,800);
});

/* ===== SPEED ===== */
let speedTime=30, speedTimer=null, speedScore=0, speedCurrent=null;
function startSpeed(){ speedTime=30; speedScore=0; document.getElementById('speed-score').textContent=speedScore; document.getElementById('speed-status').textContent=''; document.getElementById('speed-timer').textContent='30s'; document.getElementById('speed-input').value=''; nextSpeed(); if(speedTimer) clearInterval(speedTimer); speedTimer=setInterval(()=>{ speedTime--; document.getElementById('speed-timer').textContent = speedTime+'s'; if(speedTime<=0){ clearInterval(speedTimer); endSpeed(); } },1000); document.getElementById('speed-input').focus(); }
function nextSpeed(){ speedCurrent = rand(active); document.getElementById('speed-uk').textContent = speedCurrent.uk; document.getElementById('speed-input').value=''; }
document.getElementById('speed-input').addEventListener('keyup', (e)=>{
  if(e.key !== 'Enter') return;
  if(!speedCurrent || speedTime<=0) return;
  const val = e.target.value.trim().toLowerCase();
  if(val === speedCurrent.en.toLowerCase()){ speedScore++; document.getElementById('speed-status').textContent='‚úÖ'; document.getElementById('speed-status').style.color='green'; } else { document.getElementById('speed-status').textContent='‚ùå '+speedCurrent.en; document.getElementById('speed-status').style.color='red'; }
  document.getElementById('speed-score').textContent = speedScore;
  nextSpeed();
});
function endSpeed(){ document.getElementById('speed-uk').textContent='–ß–∞—Å –≤–∏—á–µ—Ä–ø–∞–Ω–æ!'; document.getElementById('speed-status').textContent=`–í–∏ –Ω–∞–±—Ä–∞–ª–∏ ${speedScore}`; if(speedScore>Math.max(1,Math.floor(active.length/3))) firework(); }

/* ===== controls ===== */
function applyAll(){ buildActive(); initAll(); }
function shuffleAll(){ buildActive(); initAll(); }
function initAll(){ startFlash(); startDialog(); startMatch(); startListening(); startTyping(); /* speed waits for user */ }

/* ===== init ===== */
buildActive(); initAll(); openGame('flash');

/* keyboard shortcuts */
document.addEventListener('keydown',(e)=>{
  if(e.key==='1') openGame('flash');
  if(e.key==='2') openGame('dialog');
  if(e.key==='3') openGame('match');
  if(e.key==='4') openGame('listen');
  if(e.key==='5') openGame('type');
  if(e.key==='6') openGame('speed');
});
</script>
</body>
</html>
